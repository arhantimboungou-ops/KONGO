<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KONGO MARKET PRO | Marketplace Intelligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root { --primary: #10b981; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        .premium-card { 
            background: white;
            border-radius: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.03);
        }
        .premium-card:hover { transform: translateY(-8px); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.08); }

        .loader-active { display: flex !important; }
        
        .cat-btn.active { background-color: var(--primary); color: white; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Overlay de chargement -->
    <div id="global-loader" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[1000] hidden items-center justify-center flex-col gap-4">
        <div class="w-14 h-14 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-white font-bold tracking-widest uppercase text-xs">Traitement sécurisé...</p>
    </div>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 glass-nav h-20">
        <div class="container mx-auto px-4 flex justify-between items-center h-full">
            <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
                <div class="w-12 h-12 bg-emerald-600 rounded-2xl flex items-center justify-center text-white shadow-xl rotate-3 hover:rotate-0 transition-all">
                    <i class="fas fa-bolt text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold text-slate-900 leading-none">KONGO<span class="text-emerald-500">MARKET</span></h1>
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Version Intelligence Pro</span>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <div id="user-controls" class="hidden flex items-center gap-2">
                    <button onclick="toggleViewMode()" id="toggle-view-btn" class="p-2.5 rounded-xl bg-slate-100 text-slate-600 hover:bg-emerald-50 hover:text-emerald-600 transition-all">
                        <i class="fas fa-boxes-stacked"></i>
                    </button>
                    <button onclick="handleSignOut()" class="w-10 h-10 rounded-xl bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
                <button onclick="checkAuthForAdd()" class="bg-slate-900 text-white px-6 py-3.5 rounded-2xl font-bold text-sm hover:bg-emerald-600 shadow-xl transition-all flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i> <span class="hidden md:inline">Publier</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Header & Filtres -->
    <header class="bg-white border-b py-12 mb-8">
        <div class="container mx-auto px-4">
            <div class="max-w-3xl mx-auto text-center mb-10">
                <h2 class="text-3xl md:text-5xl font-black text-slate-900 mb-4">Trouvez ce dont vous avez besoin.</h2>
                <div class="relative group">
                    <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-emerald-500 transition-colors"></i>
                    <input type="text" id="search-bar" oninput="handleSearch()" placeholder="iPhone, Toyota, Appartement..." class="w-full pl-14 pr-6 py-5 rounded-[2rem] bg-slate-50 border-2 border-transparent focus:border-emerald-500 outline-none transition-all shadow-sm text-lg font-medium">
                </div>
            </div>
            
            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 justify-start md:justify-center" id="category-bar">
                <!-- Filtres injectés ici -->
            </div>
        </div>
    </header>

    <!-- Grid -->
    <main class="container mx-auto px-4 pb-20 min-h-[50vh]">
        <div id="status-text" class="mb-8 flex justify-between items-end">
            <div>
                <h3 id="view-title" class="text-xl font-black text-slate-900 uppercase">Annonces récentes</h3>
                <p id="results-count" class="text-xs font-bold text-slate-400 mt-1">Recherche de pépites...</p>
            </div>
        </div>

        <div id="ads-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            <!-- Squelette de chargement ou Annonces -->
        </div>
    </main>

    <!-- Modal Détails -->
    <div id="modal-details" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-[200] hidden items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col md:flex-row shadow-2xl animate-pop relative">
            <button onclick="closeDetails()" class="absolute right-6 top-6 z-10 w-10 h-10 rounded-full bg-white/90 shadow-lg flex items-center justify-center text-slate-900 hover:scale-110 transition-transform">
                <i class="fas fa-times"></i>
            </button>
            <div class="w-full md:w-1/2 h-64 md:h-auto bg-slate-100">
                <img id="det-img" src="" class="w-full h-full object-cover">
            </div>
            <div class="w-full md:w-1/2 p-8 md:p-12 overflow-y-auto">
                <span id="det-cat" class="text-[10px] font-black uppercase text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full"></span>
                <h3 id="det-title" class="text-3xl font-black text-slate-900 mt-4 mb-2"></h3>
                <p id="det-price" class="text-2xl font-extrabold text-emerald-500 mb-6"></p>
                <div class="bg-slate-50 rounded-2xl p-6 mb-8">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Description</h4>
                    <p id="det-desc" class="text-slate-600 leading-relaxed whitespace-pre-line"></p>
                </div>
                <div class="flex gap-4">
                    <a id="det-call" href="#" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black text-center hover:bg-emerald-600 transition-all shadow-xl">CONTACTER</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Publication -->
    <div id="modal-post" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-[200] hidden items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-2xl p-8 md:p-12 shadow-2xl relative max-h-[95vh] overflow-y-auto no-scrollbar">
            <div class="text-center mb-10">
                <h3 class="text-2xl font-black text-slate-900 mb-2">PUBLIER UNE ANNONCE</h3>
                <p class="text-xs font-bold text-slate-400 uppercase">Remplissez les informations essentielles</p>
            </div>
            
            <form id="post-form" class="space-y-6">
                <!-- Zone Upload -->
                <div class="relative group h-48 border-4 border-dashed border-slate-100 rounded-[2rem] overflow-hidden bg-slate-50 flex items-center justify-center transition-all hover:border-emerald-300">
                    <input type="file" id="f-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10" required>
                    <img id="f-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                    <div id="f-prompt" class="text-center">
                        <div class="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center mx-auto mb-3 text-emerald-500">
                            <i class="fas fa-camera text-2xl"></i>
                        </div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Ajouter une photo</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 mb-2 block">Titre de l'objet</label>
                        <input type="text" id="f-title" required placeholder="Ex: Samsung S24 Ultra Neuf" class="w-full px-6 py-4 bg-slate-50 border-2 border-transparent rounded-2xl focus:border-emerald-500 outline-none font-bold">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 mb-2 block">Prix (FCFA)</label>
                        <input type="number" id="f-price" required placeholder="0" class="w-full px-6 py-4 bg-slate-50 border-2 border-transparent rounded-2xl focus:border-emerald-500 outline-none font-bold">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 mb-2 block">Catégorie</label>
                        <select id="f-cat" class="w-full px-6 py-4 bg-slate-50 border-2 border-transparent rounded-2xl focus:border-emerald-500 outline-none font-bold">
                            <option>Électronique</option>
                            <option>Véhicules</option>
                            <option>Immobilier</option>
                            <option>Mode</option>
                            <option>Services</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 mb-2 block">Description complète</label>
                    <textarea id="f-desc" rows="4" required placeholder="Détaillez l'état, les options, le lieu de vente..." class="w-full px-6 py-4 bg-slate-50 border-2 border-transparent rounded-2xl focus:border-emerald-500 outline-none font-bold"></textarea>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closePost()" class="flex-1 py-4 text-[10px] font-black uppercase text-slate-400 hover:text-slate-900 transition-all">Annuler</button>
                    <button type="submit" class="flex-[2] bg-emerald-500 text-white py-5 rounded-[1.5rem] font-black uppercase tracking-widest shadow-xl shadow-emerald-100 hover:bg-emerald-600 transition-all">Publier l'annonce</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION (Firebase)
        const firebaseConfig = {
            apiKey: "AIzaSyBQ2NSk-dOMeXnGupqQJflU9r6HurSeLHQ",
            authDomain: "kongo-market-3f7ce.firebaseapp.com",
            projectId: "kongo-market-3f7ce",
            storageBucket: "kongo-market-3f7ce.firebasestorage.app",
            messagingSenderId: "95509786102",
            appId: "1:95509786102:web:897c20a96e5911f75a2bd7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'kongo-market-v2';

        // STATE
        let user = null;
        let allAds = [];
        let currentFilter = "Tous";
        let isOwnerView = false;
        let base64Image = null;

        // INITIALISATION
        const init = () => {
            const categories = ["Tous", "Électronique", "Véhicules", "Immobilier", "Mode", "Services"];
            const catBar = document.getElementById('category-bar');
            catBar.innerHTML = categories.map(cat => `
                <button onclick="setFilter('${cat}')" id="cat-${cat}" class="cat-btn px-6 py-3 rounded-2xl bg-white border border-slate-100 text-xs font-bold whitespace-nowrap transition-all hover:bg-emerald-50 ${cat === 'Tous' ? 'active' : ''}">
                    ${cat}
                </button>
            `).join('');

            onAuthStateChanged(auth, (u) => {
                user = u;
                document.getElementById('user-controls').classList.toggle('hidden', !u);
                fetchData();
            });
        };

        // IMAGE PREVIEW
        document.getElementById('f-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Compression intelligente simple
                if (file.size > 2 * 1024 * 1024) {
                    alert("Image trop lourde (max 2MB)");
                    e.target.value = "";
                    return;
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    base64Image = ev.target.result;
                    document.getElementById('f-preview').src = base64Image;
                    document.getElementById('f-preview').classList.remove('hidden');
                    document.getElementById('f-prompt').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // FIRESTORE SYNC
        const fetchData = () => {
            // Rule 1: Use specific path
            const adsCol = collection(db, 'artifacts', appId, 'public', 'data', 'ads');
            const q = query(adsCol, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snap) => {
                allAds = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAds();
            }, (err) => console.error("Firestore Error:", err));
        };

        // RENDER
        window.renderAds = () => {
            const container = document.getElementById('ads-container');
            const search = document.getElementById('search-bar').value.toLowerCase();
            
            let filtered = allAds.filter(ad => {
                const matchSearch = ad.title.toLowerCase().includes(search) || ad.description?.toLowerCase().includes(search);
                const matchCat = currentFilter === "Tous" || ad.category === currentFilter;
                const matchOwner = !isOwnerView || ad.ownerId === user?.uid;
                return matchSearch && matchCat && matchOwner;
            });

            document.getElementById('results-count').textContent = `${filtered.length} annonce(s) disponible(s)`;

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full py-20 text-center bg-white rounded-[2rem] border-2 border-dashed border-slate-100">
                        <i class="fas fa-box-open text-4xl text-slate-200 mb-4"></i>
                        <p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest">Aucun résultat trouvé</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(ad => `
                <div class="premium-card group overflow-hidden flex flex-col h-full cursor-pointer" onclick="openDetails('${ad.id}')">
                    <div class="h-52 overflow-hidden relative">
                        <img src="${ad.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        <div class="absolute top-4 left-4 bg-white/95 px-3 py-1.5 rounded-xl text-[8px] font-black uppercase text-emerald-600 shadow-sm">
                            ${ad.category}
                        </div>
                    </div>
                    <div class="p-6 flex-1 flex flex-col">
                        <h4 class="font-bold text-slate-900 mb-2 line-clamp-2 h-10">${ad.title}</h4>
                        <p class="text-emerald-500 font-black text-xl mb-4">
                            ${new Intl.NumberFormat().format(ad.price)} <small class="text-[9px]">FCFA</small>
                        </p>
                        <div class="mt-auto pt-4 border-t flex justify-between items-center">
                            <span class="text-[9px] font-black text-slate-300 uppercase tracking-tighter">Posté par un Pro</span>
                            ${isOwnerView ? `
                                <button onclick="event.stopPropagation(); deleteAd('${ad.id}')" class="w-9 h-9 rounded-xl bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                </button>
                            ` : `
                                <div class="w-9 h-9 rounded-xl bg-slate-50 text-slate-400 flex items-center justify-center">
                                    <i class="fas fa-chevron-right text-[10px]"></i>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `).join('');
        };

        // ACTIONS
        window.setFilter = (cat) => {
            currentFilter = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`cat-${cat}`).classList.add('active');
            renderAds();
        };

        window.handleSearch = () => renderAds();

        window.toggleViewMode = () => {
            isOwnerView = !isOwnerView;
            document.getElementById('view-title').textContent = isOwnerView ? "Mes Annonces" : "Annonces récentes";
            document.getElementById('toggle-view-btn').classList.toggle('bg-emerald-500', isOwnerView);
            document.getElementById('toggle-view-btn').classList.toggle('text-white', isOwnerView);
            renderAds();
        };

        window.checkAuthForAdd = async () => {
            if (!user) {
                document.getElementById('global-loader').classList.add('loader-active');
                try {
                    await signInAnonymously(auth);
                } catch (e) { alert("Erreur de connexion."); }
                document.getElementById('global-loader').classList.remove('loader-active');
            }
            document.getElementById('modal-post').classList.remove('hidden');
        };

        window.closePost = () => document.getElementById('modal-post').classList.add('hidden');

        document.getElementById('post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!base64Image) return alert("Photo obligatoire.");

            document.getElementById('global-loader').classList.add('loader-active');

            try {
                const adsCol = collection(db, 'artifacts', appId, 'public', 'data', 'ads');
                await addDoc(adsCol, {
                    title: document.getElementById('f-title').value.trim(),
                    price: Number(document.getElementById('f-price').value),
                    category: document.getElementById('f-cat').value,
                    description: document.getElementById('f-desc').value.trim(),
                    image: base64Image,
                    ownerId: user.uid,
                    createdAt: serverTimestamp()
                });
                
                e.target.reset();
                base64Image = null;
                document.getElementById('f-preview').classList.add('hidden');
                document.getElementById('f-prompt').classList.remove('hidden');
                closePost();
            } catch (err) {
                alert("Erreur de publication.");
            } finally {
                document.getElementById('global-loader').classList.remove('loader-active');
            }
        });

        window.deleteAd = async (id) => {
            if (confirm("Supprimer cette annonce définitivement ?")) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'ads', id);
                await deleteDoc(docRef);
            }
        };

        window.openDetails = (id) => {
            const ad = allAds.find(a => a.id === id);
            if (!ad) return;
            document.getElementById('det-img').src = ad.image;
            document.getElementById('det-cat').textContent = ad.category;
            document.getElementById('det-title').textContent = ad.title;
            document.getElementById('det-price').textContent = `${new Intl.NumberFormat().format(ad.price)} FCFA`;
            document.getElementById('det-desc').textContent = ad.description;
            document.getElementById('modal-details').classList.remove('hidden');
            document.getElementById('modal-details').classList.add('flex');
        };

        window.closeDetails = () => {
            document.getElementById('modal-details').classList.add('hidden');
            document.getElementById('modal-details').classList.remove('flex');
        };

        window.handleSignOut = () => signOut(auth);

        init();
    </script>
</body>
</html>